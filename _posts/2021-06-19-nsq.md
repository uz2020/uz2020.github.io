---
layout: post
title:  "nsq"
tags: go
---

今天初步调通对接接口，现在就面临一个问题：拉取回来的数据，应该直接导入数据库，还是先放到一个中间件？一直以来做的项目都比较小，用与不用中间件区别不大。这也导致我对中间件的理解太浅。难得现在有机会自己来决定技术栈，我就想多尝试，找出各种实现方式的优缺点。

本来想趁现在有空研究一下RabbitMQ，但后来再想了一下，既然Go社区如此兴旺，为何不看看Go有没有类似的产品出来？所以就找到了这个nsq，研究一下是否适用。

在Go如此popular的今天，rust究竟适合做什么？k8s和docker都是由golang写的，整个生态圈也都围绕着容器，微服务和go相关的项目转，似乎没有rust什么事。那rust既然生存下来了，必然有它的过人之处。先埋下一个伏笔，后面抽空再研究rust。

言归正转，来学习一下nsq。

## nsq

特点：

1. 分布式、去中心化、无单点故障。（SPOF：single point of failure）
2. 是一个消息交付服务。
3. 可扩展性通过服务自发现来支持，添加新节点很方便。（horizontal scalable）
4. 支持订阅/发布消息和消息负载均衡交付（delivery）。
5. 配置简单，有UI。
6. 支持多种语言接入。

nsq由好几部分组成：

1. nsqlookupd
2. nsqd
3. nsqadmin
4. nsq_to_file

发布消息：

```bash
$ curl -d 'hello world 1' 'http://127.0.0.1:4151/pub?topic=test'
```

## nsqd

```bash
$ nsqd --lookupd-tcp-address=127.0.0.1:4160
```

```bash
[l@pc ~]$ nsqd --lookupd-tcp-address=127.0.0.1:4160
[nsqd] 2021/06/19 23:32:28.453897 INFO: nsqd v1.2.1-alpha (built w/go1.16.5)
[nsqd] 2021/06/19 23:32:28.453953 INFO: ID: 181
[nsqd] 2021/06/19 23:32:28.454366 INFO: TOPIC(test): created
[nsqd] 2021/06/19 23:32:28.454470 INFO: TOPIC(test): new channel(nsq_to_file)
[nsqd] 2021/06/19 23:32:28.454492 INFO: NSQ: persisting topic/channel metadata to nsqd.dat
[nsqd] 2021/06/19 23:32:28.460399 INFO: LOOKUP(127.0.0.1:4160): adding peer
[nsqd] 2021/06/19 23:32:28.460486 INFO: LOOKUP connecting to 127.0.0.1:4160
[nsqd] 2021/06/19 23:32:28.460491 INFO: HTTP: listening on [::]:4151
[nsqd] 2021/06/19 23:32:28.460518 INFO: TCP: listening on [::]:4150
[nsqd] 2021/06/19 23:32:28.461305 INFO: LOOKUPD(127.0.0.1:4160): peer info {TCPPort:4160 HTTPPort:4161 Version:1.2.1-alpha BroadcastAddress:pc}
[nsqd] 2021/06/19 23:32:28.461326 INFO: LOOKUPD(127.0.0.1:4160): REGISTER test nsq_to_file
[nsqd] 2021/06/19 23:32:28.461507 INFO: LOOKUPD(127.0.0.1:4160): topic REGISTER test
[nsqd] 2021/06/19 23:32:28.461635 INFO: LOOKUPD(127.0.0.1:4160): channel REGISTER test nsq_to_file
```

## nsqlookupd

```bash
[l@pc nsq]$ nsqlookupd
[nsqlookupd] 2021/06/19 23:26:28.963652 INFO: nsqlookupd v1.2.1-alpha (built w/go1.16.5)
[nsqlookupd] 2021/06/19 23:26:28.964280 INFO: HTTP: listening on [::]:4161
[nsqlookupd] 2021/06/19 23:26:28.964309 INFO: TCP: listening on [::]:4160
```

## nsqadmin提供web服务

nsqadmin是一个web服务。该web服务提供admin页面用来查看或管理topic和消息。它使用4171端口。

```bash
$ nsqadmin --lookupd-http-address=127.0.0.1:4161
```

```bash
[l@pc ~]$ nsqadmin --lookupd-http-address=127.0.0.1:4161
[nsqadmin] 2021/06/19 23:27:51.025073 INFO: nsqadmin v1.2.1-alpha (built w/go1.16.5)
[nsqadmin] 2021/06/19 23:27:51.025875 INFO: HTTP: listening on [::]:4171
```

