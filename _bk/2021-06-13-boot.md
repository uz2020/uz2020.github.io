---
layout: post
title:  "启动盘"
---

我还是没搞懂efi的启动流程是什么，确切地讲，我连传统的启动方式也不太懂。

但这还是不妨碍我成功地做出了两种方式的启动盘。在我的印象中，efi还没出
现时，或者uefi还没出现时，硬盘都是采用MBR格式的。MBR大概是一种分区表的
格式吧？后来uefi逐渐流行起来了，但为了兼容以前的的硬盘分区表格式，所有
有legacy mode（*你看，我把efi、MBR、gpt混为一谈，确实糟糕，有空我真的要
好好研究它们之间的关系！*）。

那么两种方式的启动盘应该怎么做呢？

## MBR

用fdisk对硬盘分区，最多只支持三个主分区和一个扩展分区。扩展分区中可以
有很多个分区，但它们同属于扩展分区。

采用MBR方式的硬盘，是没有必要创建一个efi分区的。在grub install时，应该
执行如下命令:
```bash
grub-install --target i386-pc /dev/sda
```

## uefi

要用这种方式启动，硬盘就要采用gpt的分区格式。gpt有很多好处，最大的好处
是它不区分主/扩展分区，它总共支持128个分区。

除了创建/、swap分区，还要创建一个efi分区。该efi分区的文件系统格式是
ef00。格式化该分区的命令如下（假设分区标号为sda3）:
```bash
mkfs.vfat -F 32 /dev/sda3
```

完了以后，先挂载好所有分区，包括efi。efi分区可以挂载到/efi，这个没有什
么要求。之后就是grub install了。此时的命令有所不同:
```bash
grub-install --target x86_64-efi --efi-directory /efi /dev/sda
```

efi的方式，我记得是对dual-boot的设置很有帮助，包括dual-boot
Windows/MacOS/FreeBSD。

## 奇怪的问题

因为不是所有笔记本都允许我们随便插拔硬盘的，所以我想做一个事情就是，
sata接口转usb接口之后能够启动系统。另外一件事就是直接把系统安装到一个u
盘里。

这两件事昨晚都尝试成功了，但缺点是usb慢啊。如果是usb 3.0还好，但我手头
的老机器都是usb 2.0的，只好忍耐了，总比没有好。

把系统安装到u盘没有太多的问题，一切顺利，用的efi模式。但是把系统装到硬
盘之后，启动就有问题了，efi和MBR都尝试过。grub引导时会报找不到
/dev/sda1，或者找不到UUID=...之类的错误。奇怪的是，在我百思不得其解时，
尝试换了另外一个sata转usb接口，居然就成功了。我估计是之前那个转接口怼
进来时，系统把硬盘识别成了/dev/sdb之类的吧，但我实在无法验证。

另外一个奇怪的问题就是，这不今天早上我买的nec vk17到了吗，我就想用usb
的方式启动系统，却发现MBR的可以，efi就启动不了（但在我的t420上试过都没
问题）。但是，之前做的启动盘（archlinux系统安装盘）也是gpt分区格式的，
也用的是efi。反正这一点让人挺困惑的，可能官方做的iso还是比我的硬盘做得
更周全一些吧。

## 小结

不管怎样，我想如果以后我不想带电脑出门，我还是可以只带着个u盘出去，在
有电脑的地方，我就可以借用来干活了。*轻松！*{:.green}

## 再一次被efi坑

没想到下午机器就到了。机器不错，但我换上装有archlinux的硬盘却死活启动
不了。

原来这个x220的uefi有bug，它限制了efi文件的路径。而t420就没有这个问题。
使用grub-install安装efi文件时，grubx64.efi会安装在/EFI/arch/里。也就是
```bash
/EFI/arch/grubx64.efi
```

而x220的uefi根本就不会去arch里面找，它只会到这里去找：
```bash
/EFI/boot/bootx64.efi
```

所以只要手动创建一个/EFI/boot目录和copy一下文件就可以了。关于
grubx64.efi和bootx64.efi的区别我也不清楚，大概是不同的bootloader的efi
名字不同吧，所以统一命名为bootx64.efi之后uefi firmware就能找到了。

除了在网上找资料发现这个问题的原因，我们也可以看看神奇的官方镜像启动盘，
它教会我们一些best practice。做启动盘，我们只敲了一行dd的命令就完成了，
到底发生了什么？这值得我们研究。原来这个iso文件就相当于是一个硬盘。dd
这个iso到硬盘就相当于copy出一个和iso一模一样内容的硬盘。而这个iso里面
是什么呢？它里面是一个分区表格式为gpt的包含三个分区的硬盘。第一个分区
相当于正常启动的系统的/分区吧。第二分区我不知道干嘛的。第三个分区就是
efi分区了。uefi firmware正是通过gpt分区表找到了这个efi分区，再从里面找
到bootloader，从而引导到了第一个分区，才有了安装系统的界面。我们都记得
安装archlinux时，首先弹出的界面是三个选项

1. 安装系统
2. 记得是启动existing system
3. efi shell

这个界面是谁呈现的？没错，呈现这个界面的正是efi分区里面的bootloader。
在我们选择了第一项之后，这个bootloader才会引导到第一个分区，于是屏幕就
会刷刷地出现操作系统启动时的大量日志。那么现在关键就是去参看efi分区里
是怎么布局的，参考它布局必然能给我们带来**灵感**{:.red}。我们看到了有
一个叫EFI/BOOT/bootx64.efi的文件。虽然除了这个之外，还有
arch/boot/grubx64.efi，但前者才是关键。不同的厂商制作的uefi firmware不
一定能认出所有efi bootloader。比如这个arch/boot/grubx64.efi一看就感觉
是archlinux系统自己才有的。所以，最标准的是EFI/BOOT/bootx64.efi。只要
有这个存在，uefi就能找到这个bootloader，所以这就是**答案**{:.red}啊！
我们只要仿照着把我们希望uefi引导的bootloader扔到那里，并且重命名为
bootx64.efi就大功告成了。

这个efi分区其实挂不挂载倒无所谓，那是uefi的事情，它必须挂载了才能读出
bootloader。至于在正式引导系统成功了以后，bootloader就没有意义了，甚至
把这efi分区当场删除掉也不影响系统运行，只不过重启系统就会悲剧而已。只
是不知为何很多资料说要把它挂载到/boot/efi、/efi、/boot，搞得乱七八糟的，
也许有特殊的作用吧，不过我平常的使用根本用不到。/boot目录也是一个神奇
的目录，被人们把efi也混进来一起讲之后就把初学者搞晕了。

关于/boot我想再聊聊。有的教程让我们为/boot分配一个分区，以前我也是这么
做的，虽然不知道有什么好处，反正就是搞得更麻烦了吧。现在的做法基本就是，
只分配/、swap、efi三个分区。我在想为什么有人推荐给/boot一个分区，也许
是他们常常升级和搞内核？他们怕/分区如果坏了会影响到内核文件么？据我所
知，/boot里面主要就是几个和内核相关的文件，还有一个/boot/grub/grub.cfg。
看/boot/grub里面的内容还有点复杂，甚至有fonts、locale、themes之类的东
西。我想这些大概是为了帮助grub bootloader更好地呈现启动界面的一些资源
吧？但/boot下面就简单多了，只有三个文件：

```bash
initramfs-linux-fallback.img  initramfs-linux.img  vmlinuz-linux
```

猜测就是两个内核文件（一个正式、一个fallback），还有一个vmlinuz-linux
见过很多次也不知道是干嘛的。总之这些img都不大，都是10MB以下。可见虽然
内核复杂，也不见得比某些大公司写的逻辑罗嗦，动辄上百M的也很常见。可能
真的是业务逻辑太多了？

回头再说说这个/boot/grub/grub.cfg。之前我很惊讶为何grub能够找到这个文
件？假如我搞了两个一模一样的/分区，它怎么知道上哪里找？因为
grub-mkconfig时也仅仅是生成grub.cfg这个文件，它并没有去告诉grub
bootloader它的位置。在不知道grub bootloader的逻辑的前提下，我只能猜测
如果一个硬盘有多个ext4之类的分区，它会逐个分区挂载，然后找
/boot/grub/grub.cfg，如果找到，就认为这是/分区了，就准备从这里引导了。
我们再回忆一下grub引导的场景。在按下开机键以后，显示操作系统选择菜单之
前还有一个界面，那个界面很快地闪过，仅仅是有一行与grub相关的信息吧，具
体我不记得了。我想就是在那个时候grub bootloader就在尝试识别出/分区来做
引导了。当我们看到操作系统选择菜单的时候，就说明此时grub bootloader已
经成功识别出/分区，并且把/boot/grub/grub.cfg的内容展示给我们了。

## 再小结

一开始引导不进去系统时，我就怀疑是我做的系统不标准，所以查阅了一些uefi
的资料。原来uefi既可以启动gpt分区表的硬盘，也可以启动MBR分区表的硬盘。
但前提是它们都要分配一个独立的efi分区，文件系统格式为FAT-32（FAT-16也
行，只是兼容性没这么好）。那么uefi怎么从硬盘中找到这个efi分区呢？uefi
从分区表中就可以确定出efi分区。但在两种分区表中，efi分区的表示是不一样
的。MBR用一个字节表示分区格式（0XEF）。而在gpt中，efi是通过一个叫GUID
的东西来识别的。在gpt中，所有的分区都有自己的GUID，但唯独efi的GUID是由
标准决定的，uefi只要看到这个GUID就会认为它就是efi分区了。这个GUID当然
是不用我们自己去设置的。在使用parted、gdisk之类的工具时设置好分区格式
为EF00或者打上esp的tag之后，这个GUID自动就设置好了。uefi找到efi分区之
后，就找到了bootloader，由于dual/multi boot的需要，可能会有多个
bootloader。这些bootloader就是bootx64.efi、grubx64.efi之类的文件了。至
于这些bootlader是怎么制作的我就不清楚了，我是用grub-install来生成的。
bootloader被调起之后，它就会去找/boot/grub/grub.cfg。它是怎么找到的？
它怎么知道这个配置文件在哪个分区里？我也觉得神奇，那就等我搞懂了再回来
说两句吧。**欲知后事如何，请听下回分解。**{:.green}

*啊哈，没想到我这么快已经想明白了，下回分解已经补充在前面了*：[再一次被
efi坑](#再一次被efi坑)。

再说说这台x220。

这台x220成色很不错。键盘、屏幕、电池、散热、性能以及整体外观都很好。我
为挑选这个机器熬的夜总算没有白费。现在就已经在用它来工作了。680块确实
不算便宜，但也不算贵呢！不过在我最近几年用的机器里面而言，确实算是高级
货了。蔡老板说过，买东西要考虑的是有没有必要买，买不买得起。而不是值不
值得。

不过这两天折腾也是把我生活节奏搞得够乱的，硬盘、系统、机器、u盘，螺丝
刀放得乱七八糟了。所以现在就去收拾~
