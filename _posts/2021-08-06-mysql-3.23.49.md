---
layout: post
---

在dockerhub上找到debian/eol镜像。它支持的最老的debian版本是potato，非常小，才44M。

创建容器：

```bash
docker run -it -d --name m3 -v "$PWD/code/mysql-3.23.49/":/root/mysql debian/eol:potato bash
```

注意，github上有个误导人的版本mysql-3.23.49，里面的Makefile有问题。要确保下载正确的源码。

进去容器：
```bash
docker exec -it m3 bash
```

进去后安装gcc、g++等，安装后发现gcc版本为2.95，正好是编译mysql-3.23.49推荐的gcc版本。

编译完以后，就根据ref manual来部署就可以。

启动mysql服务器时要注意的地方：

> For versions of MySQL older than 4.0, substitute safe_mysqld for mysqld_safe in the command.

可以把这个容器作为镜像，方便后续需要重建容器：

```bash
docker commit m3 m-3.23.49
```

## innodb配置

```ini
# Uncomment the following if you are using Innobase tables
#innodb_data_file_path = ibdata1:400M
#innodb_data_home_dir = /usr/local/var/
#innodb_log_group_home_dir = /usr/local/var/
#innodb_log_arch_dir = /usr/local/var/
#set-variable = innodb_mirrored_log_groups=1
#set-variable = innodb_log_files_in_group=3
#set-variable = innodb_log_file_size=5M
#set-variable = innodb_log_buffer_size=8M
#innodb_flush_log_at_trx_commit=1
#innodb_log_archive=0
#set-variable = innodb_buffer_pool_size=16M
#set-variable = innodb_additional_mem_pool_size=2M
#set-variable = innodb_file_io_threads=4
#set-variable = innodb_lock_wait_timeout=50
```

innodb_log_arch_dir中arch表示的是archived，非architecture。日志文件有多个，分别是：
1. ib_arch_log_0000000000
2. ib_logfile0， ib_logfile1

innodb tablespace存储文件为： ibdata1。

启动：

```bash
bin/safe_mysqld --user=mysql &
```

停止：

```bash
bin/mysqladmin -u root shutdown
```

查看engine，该命令在4.1才实现：

```bash
show engines \G
```

查看建表语句：

```bash
show create table tbl
```

创建innodb table（在后面的版本，使用ENGINE代替TYPE）：

```
create table tbl(a INT) TYPE=innodb
```

以上命令会在innodb内部执行：

1. index on column a
2. 在数据库test目录下创建customers.frm文件
3. InnoDB添加表到它的data dictionary


查看表占用了多少InnoDB tablespace：

```
SHOW TABLE STATUS FROM test LIKE 'customers'
```


## innodb transaction

transaction-safe storage engine

1. commit
2. rollback
3. crash-recovery

## innodb buffer pool

用于caching

1. caching data
2. caching indexes

## innodb tablespace

用于存储

1. tables
2. indexes

配置中指定tablespace可以是多个文件，每个文件可以选择是固定大小还是autoextend。autoextend默认每次增加8M的容量。可以用max指定可扩展文件的最大值。

注意，autoextend在3.23.50之后才支持。

在4.1.1之后，MySQL支持per-table tablespaces。

## innodb 目标

> used in production at numerous large database sites requiring high performance.

## innodb 热备 (hot backup)

这是commercial feature。

## mysql进程模型

mysql使用线程。每个线程的stack大约是2MB。每个网络连接用一个线程来处理。

每个连接需要维护的数据大小：
1. sort_buffer_size
2. read_buffer_size
3. binlog_buffer_size

还有key buffer是MyISAM用到的内存。

再加上innodb用的buffer pool，可以算出大概要用到的内存大小。
