---
layout: post
title: Kernel 2.6.12 编译
---

学习一个旧版本的内核很有必要。

今天编译一个旧版本的内核（2.6.12），它的压缩包只有39M。比起最新版本的内核114M的大小而言，算是比较轻量了。

README文档里提到要求gcc的版本是2.95.3，这让我很头疼。折腾了半天，最多也只能搞出32位版本出来。实际上2.95.3就只支持32位版本。而这个2.6.12的内核却支持64位系统，说明它不是用gcc 2.95.3来编译的。

一个Linux系统，它自身的环境应该能编译它自己的内核。ubuntu 5.10使用的是2.6.12版本的内核。在上面安装好gcc以后，再apt-get install linux-source，就可以去编译了。用的是gcc-3.4。

解压tarball以后，进入内核代码根目录。

```bash
mkdir bld
make O=bld defconfig
cd bld
make -j4
make modules_install
make install
update-grub
reboot
```

ubuntu 5.10的iso只能在官网下载，但个别镜像地址还提供软件源比如ustc。安装在qemu之后，在编译内核时发现cpu只有1个，原因是内核编译时并没有打开smp。

make defconfig是使用默认配置。一般而言会少很多driver，从而编译得更快，我开4线程跑时只花了2min左右就编译好了。如果直接make oldconfig，那么就会编译很多用不上的driver。

注意，.config文件是自动生成的，在上面修改是没有意义的。今天我在这个问题上栽了跟头，一直以为直接修改.config就可以改变编译选项。

另外地，搞内核开发必须在虚拟机上。docker只是把内核之上的框架换成它自己的，而内核还是host的内核。我也尝试在docker上编译内核，但首先要找到合适的gcc。gcc官方站点维护的最老的版本已经是4.9了，因此不能用于编译旧版本内核。即使幸运地找到gcc 3.4，最终要测试内核时也是要有一个运行环境，所以安装一个ubuntu 5.10在所难免。

我觉得最酷的方法是LFS，可以任意定制环境，但是坑太多了。

如果想要学习gcc，那么通过docker安装一个旧版本的debian/eol，在上面编译旧版本gcc如2.95，也是一个不错的方法。毕竟我们只是想知道它的框架，其它的细节并不是很关心。因为很多项目看起来庞大，但它们的核心框架其实在多年以前就已经稳定下来了。使他们看起来庞大的，都是细枝末叶，就像树一样。
